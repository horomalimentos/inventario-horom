<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Compras - Inventario</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    h2 { margin-bottom: 20px; }
    table { width: 100%; margin: auto; border-collapse: collapse; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; cursor: pointer; }
    input[type="date"] { padding: 6px; margin-bottom: 15px; font-size: 14px; }
    .mensaje { margin: 10px; font-size: 14px; color: red; }
    .footer { margin-top: 30px; font-size: 12px; color: gray; }
    @media (max-width: 600px) {
      table { font-size: 12px; }
      th, td { padding: 4px; }
      input[type="date"] { width: 90%; }
    }
  </style>
</head>
<body>

<h2>Compras - Reporte de Inventarios üõí</h2>

<input type="date" id="filtroFecha">
<button onclick="filtrarFecha()">Filtrar</button>

<div class="mensaje" id="mensaje"></div>

<table id="tabla-compras">
  <thead>
    <tr>
      <th onclick="ordenarTabla(0)">Fecha</th>
      <th onclick="ordenarTabla(1)">Usuario</th>
      <th onclick="ordenarTabla(2)">Ubicaci√≥n</th>
      <th onclick="ordenarTabla(3)">√Årea</th>
      <th onclick="ordenarTabla(4)">Art√≠culo</th>
      <th onclick="ordenarTabla(5)">Cantidad</th>
      <th onclick="ordenarTabla(6)">Solicit√≥</th>
    </tr>
  </thead>
  <tbody id="tbody-compras"></tbody>
</table>

<div class="footer">
  Aplicaci√≥n para administraci√≥n de inventarios para PYMES ‚Äî Alejandro Ornelas Orom Soluciones
</div>

<script>
const server = "https://inventario-horom-production.up.railway.app";
let datosGlobal = [];

async function cargarDatos() {
  try {
    const res = await fetch(`${server}/nombres`);
    const inventarios = await res.json();
    datosGlobal = [];

    inventarios.forEach(inv => {
      const fecha = new Date(inv.creadoEn).toLocaleDateString("es-MX", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      for (const [articulo, cantidadSolicito] of Object.entries(inv.articulos || {})) {
        const [cantidad, solicitoParte] = cantidadSolicito.split('|').map(x => x.trim());
        const solicito = solicitoParte?.replace('Solicito:', '').trim() || "No";
        datosGlobal.push({
          fecha,
          usuario: inv.nombre,
          ubicacion: inv.ubicacion,
          area: inv.area,
          articulo,
          cantidad,
          solicito
        });
      }
    });

    pintarTabla(datosGlobal);
  } catch (error) {
    console.error(error);
    document.getElementById("mensaje").textContent = "‚ùå Error al cargar inventarios.";
  }
}

function pintarTabla(datos) {
  const tbody = document.getElementById("tbody-compras");
  tbody.innerHTML = "";

  if (datos.length === 0) {
    document.getElementById("mensaje").textContent = "‚ö†Ô∏è No hay datos disponibles.";
    return;
  } else {
    document.getElementById("mensaje").textContent = "";
  }

  datos.forEach(d => {
    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${d.fecha}</td>
      <td>${d.usuario}</td>
      <td>${d.ubicacion}</td>
      <td>${d.area}</td>
      <td>${d.articulo}</td>
      <td>${d.cantidad}</td>
      <td>${d.solicito}</td>
    `;
    tbody.appendChild(fila);
  });
}

function ordenarTabla(n) {
  const tabla = document.getElementById("tabla-compras");
  let switching = true;
  let dir = "asc";
  let switchcount = 0;

  while (switching) {
    switching = false;
    const rows = tabla.rows;
    for (let i = 1; i < (rows.length - 1); i++) {
      let debeCambiar = false;
      const x = rows[i].getElementsByTagName("TD")[n];
      const y = rows[i + 1].getElementsByTagName("TD")[n];

      if (dir === "asc") {
        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
          debeCambiar = true;
          break;
        }
      } else if (dir === "desc") {
        if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
          debeCambiar = true;
          break;
        }
      }
    }
    if (debeCambiar) {
      rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
      switching = true;
      switchcount++;
    } else {
      if (switchcount === 0 && dir === "asc") {
        dir = "desc";
        switching = true;
      }
    }
  }
}

function filtrarFecha() {
  const fechaInput = document.getElementById("filtroFecha").value;
  if (!fechaInput) {
    pintarTabla(datosGlobal);
    return;
  }

  const fechaBuscada = new Date(fechaInput).toLocaleDateString("es-MX", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  const datosFiltrados = datosGlobal.filter(d => d.fecha === fechaBuscada);

  pintarTabla(datosFiltrados);
}

cargarDatos();
</script>

</body>
</html>
