<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inventario √Årea Caja üì¶</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    h2 { margin-bottom: 20px; }
    table { width: 95%; margin: auto; border-collapse: collapse; font-size: 15px; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #f2f2f2; }
    input[type="number"], select { width: 70px; padding: 5px; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 15px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #218838; }
    .mensaje { margin-top: 15px; font-size: 16px; }
    .footer { margin-top: 30px; font-size: 12px; color: gray; }
  </style>
</head>
<body>

<h2>Inventario √Årea Caja üì¶</h2>

<form id="formulario-caja">
  <table>
    <thead>
      <tr>
        <th>Art√≠culo</th>
        <th>Cantidad</th>
        <th>¬øSolicit√≥?</th>
      </tr>
    </thead>
    <tbody id="tabla-articulos"></tbody>
  </table>

  <button type="submit" id="btn-guardar">Guardar Inventario</button>
</form>

<div class="mensaje" id="mensaje"></div>

<div class="footer">
  Aplicaci√≥n para administraci√≥n de inventarios para PYMES ‚Äî Alejandro Ornelas Orom Soluciones
</div>

<script>
const articulos = [
  "CONO CHICO", "CONO GDE", "QUESOCREMA", "COCA VIDRIO", "COCACOLA", "COCACOLA 2L",
  "FANTA", "FRESCA", "MANZANITA", "SPRITE", "RANCH", "AGUA 1LT", "BOLSA CAM",
  "BOLSA DE KG", "SERVILLETAS", "TENEDOR", "CURTIDOS NACHOS GDE", "QUESO AMAR",
  "ESCOBA", "PAPEL BA√ëO", "RAID MOSC", "LIMON", "HAPPY BOX", "MINI BOX", "CHAROLA",
  "TAKIS", "ANGUILA", "SALSA HABANERO", "TARTARA", "PALILLOS", "COFIAS", "CLORO",
  "FABULOSO", "JABON", "ROLLO IMPRE"
];

const server = "https://inventario-horom-production.up.railway.app";
const tabla = document.getElementById("tabla-articulos");

articulos.forEach((nombre, index) => {
  const fila = document.createElement("tr");
  fila.innerHTML = `
    <td>${nombre}</td>
    <td><input type="number" min="0" id="input-${index}" placeholder="0" required></td>
    <td>
      <select id="solicito-${index}">
        <option value="No">No</option>
        <option value="Si">S√≠</option>
      </select>
    </td>
  `;
  tabla.appendChild(fila);
});

const inputs = Array.from(document.querySelectorAll('input[type="number"]'));
inputs.forEach((input, index) => {
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      if (index + 1 < inputs.length) inputs[index + 1].focus();
      else document.getElementById("btn-guardar").focus();
    }
  });
});

// Evitar cerrar accidentalmente
window.addEventListener('beforeunload', function (e) {
  e.preventDefault();
  e.returnValue = '';
});

document.getElementById("formulario-caja").addEventListener("submit", async (e) => {
  e.preventDefault();

  const mensaje = document.getElementById("mensaje");
  const datosUsuario = JSON.parse(localStorage.getItem("tempDatos"));

  if (!datosUsuario) {
    mensaje.style.color = "red";
    mensaje.textContent = "‚ùå No se encontraron los datos del usuario.";
    return;
  }

  const datos = {};
  let todosLlenos = true;
  articulos.forEach((nombre, index) => {
    const cantidad = document.getElementById(`input-${index}`).value.trim();
    const solicito = document.getElementById(`solicito-${index}`).value;
    if (cantidad === "") todosLlenos = false;
    datos[nombre] = `${cantidad} | Solicito: ${solicito}`;
  });

  if (!todosLlenos) {
    mensaje.style.color = "red";
    mensaje.textContent = "‚ùå No dejes campos de cantidad vac√≠os.";
    return;
  }

  try {
    if (datosUsuario.modoEdicion) {
      await fetch(`${server}/editar-nombre/${datosUsuario.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ articulos: datos, usuario: datosUsuario.usuario })
      });
    } else {
      await fetch(`${server}/guardar-nombre`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ...datosUsuario,
          articulos: datos
        })
      });
    }

    mensaje.style.color = "green";
    mensaje.textContent = "‚úÖ Inventario guardado exitosamente.";
    localStorage.removeItem("tempDatos");
    window.removeEventListener('beforeunload', () => {});
    setTimeout(() => window.close(), 1000);

  } catch (error) {
    console.error(error);
    mensaje.style.color = "red";
    mensaje.textContent = "‚ùå Error al guardar el inventario.";
  }
});
</script>

</body>
</html>
