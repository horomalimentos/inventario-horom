<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inventario √Årea Caja üì¶</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    h2 { margin-bottom: 20px; }
    table { width: 95%; margin: auto; border-collapse: collapse; font-size: 15px; margin-top: 20px; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #f2f2f2; }
    input[type="number"] { width: 70px; padding: 5px; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 15px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #218838; }
    .mensaje { margin-top: 15px; font-size: 16px; }
    .footer { margin-top: 30px; font-size: 12px; color: gray; }
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); text-align: center; padding-top: 100px; z-index: 1000;
    }
    .modal-content {
      background: white; margin: auto; padding: 20px; border-radius: 10px; width: 300px;
    }
  </style>
</head>
<body>

<h2>Inventario √Årea Caja üì¶</h2>

<!-- Formulario de la tabla -->
<form id="formulario-caja" style="display:none;">
  <table>
    <thead>
      <tr><th>Art√≠culo</th><th>Cantidad</th><th>¬øSolicit√≥?</th></tr>
    </thead>
    <tbody id="tabla-articulos"></tbody>
  </table>
  <button type="submit" id="btn-guardar">Guardar Inventario</button>
</form>

<div class="mensaje" id="mensaje"></div>

<div class="footer">
  Aplicaci√≥n para administraci√≥n de inventarios para PYMES ‚Äî Alejandro Ornelas Orom Soluciones
</div>

<!-- Modal para capturar -->
<div id="modal-captura" class="modal">
  <div class="modal-content">
    <h3 id="nombre-articulo"></h3>
    <input type="number" id="cantidad" placeholder="Cantidad" required><br><br>
    <label><input type="checkbox" id="solicito"> ¬øSolicit√≥?</label><br><br>
    <button onclick="guardarItem()">Continuar</button>
  </div>
</div>

<script>
const articulos = [
  "CONO CHICO", "CONO GDE", "QUESOCREMA", "COCA VIDRIO", "COCACOLA", "COCACOLA 2L",
  "FANTA", "FRESCA", "MANZANITA", "SPRITE", "RANCH", "AGUA 1LT", "BOLSA CAM",
  "BOLSA DE KG", "SERVILLETAS", "TENEDOR", "CURTIDOS NACHOS GDE", "QUESO AMAR",
  "ESCOBA", "PAPEL BA√ëO", "RAID MOSC", "LIMON", "HAPPY BOX", "MINI BOX", "CHAROLA",
  "TAKIS", "ANGUILA", "SALSA HABANERO", "TARTARA", "PALILLOS", "COFIAS", "CLORO",
  "FABULOSO", "JABON", "ROLLO IMPRE"
];

const server = "https://inventario-horom-production.up.railway.app";
let datosCapturados = [];
let indexArticulo = 0;

const modal = document.getElementById("modal-captura");
const nombreArticulo = document.getElementById("nombre-articulo");
const inputCantidad = document.getElementById("cantidad");
const inputSolicito = document.getElementById("solicito");

function iniciarCaptura() {
  mostrarModal();
}

function mostrarModal() {
  nombreArticulo.textContent = articulos[indexArticulo];
  inputCantidad.value = "";
  inputSolicito.checked = false;
  modal.style.display = "block";
  inputCantidad.focus();
}

function guardarItem() {
  const cantidad = inputCantidad.value.trim();
  if (cantidad === "") {
    alert("‚ö†Ô∏è Debes capturar una cantidad.");
    return;
  }
  datosCapturados.push({
    nombre: articulos[indexArticulo],
    cantidad: cantidad,
    solicito: inputSolicito.checked ? "S√≠" : "No"
  });

  indexArticulo++;
  if (indexArticulo < articulos.length) {
    mostrarModal();
  } else {
    modal.style.display = "none";
    mostrarTabla();
  }
}

function mostrarTabla() {
  const tabla = document.getElementById("tabla-articulos");
  tabla.innerHTML = "";
  datosCapturados.forEach(item => {
    tabla.innerHTML += `
      <tr>
        <td>${item.nombre}</td>
        <td>${item.cantidad}</td>
        <td>${item.solicito}</td>
      </tr>
    `;
  });
  document.getElementById("formulario-caja").style.display = "block";
}

// Evitar cerrar accidentalmente
window.addEventListener('beforeunload', function (e) {
  e.preventDefault();
  e.returnValue = '';
});

// Guardar inventario
document.getElementById("formulario-caja").addEventListener("submit", async (e) => {
  e.preventDefault();
  const mensaje = document.getElementById("mensaje");
  const datosUsuario = JSON.parse(localStorage.getItem("tempDatos"));

  if (!datosUsuario) {
    mensaje.style.color = "red";
    mensaje.textContent = "‚ùå No se encontraron los datos del usuario.";
    return;
  }

  const datos = {};
  datosCapturados.forEach(item => {
    datos[item.nombre] = `${item.cantidad} | Solicito: ${item.solicito}`;
  });

  try {
    if (datosUsuario.modoEdicion) {
      await fetch(`${server}/editar-nombre/${datosUsuario.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ articulos: datos, usuario: datosUsuario.usuario })
      });
    } else {
      await fetch(`${server}/guardar-nombre`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...datosUsuario, articulos: datos })
      });
    }
    mensaje.style.color = "green";
    mensaje.textContent = "‚úÖ Inventario guardado exitosamente.";
    localStorage.removeItem("tempDatos");
    window.removeEventListener('beforeunload', () => {});
    setTimeout(() => window.close(), 1000);
  } catch (error) {
    console.error(error);
    mensaje.style.color = "red";
    mensaje.textContent = "‚ùå Error al guardar el inventario.";
  }
});

iniciarCaptura();
</script>

</body>
</html>
