<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inventario √Årea Caja üì¶</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    h2 { margin-bottom: 20px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); text-align: center; padding-top: 80px; z-index: 1000; }
    .modal-content { background: white; margin: auto; padding: 20px; border-radius: 10px; width: 350px; }
    input[type="number"], label { margin: 10px; font-size: 16px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; }
    button.guardar { background-color: #28a745; color: white; }
    button.guardar:hover { background-color: #218838; }
    button.capturar { background-color: #3498db; color: white; }
    button.capturar:hover { background-color: #2980b9; }
    table { width: 90%; margin: auto; margin-top: 30px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f2f2f2; }
    .footer { margin-top: 30px; font-size: 12px; color: gray; }
  </style>
</head>
<body>

<h2>Inventario √Årea Caja üì¶</h2>

<div id="modal" class="modal">
  <div class="modal-content">
    <h3 id="nombre-articulo"></h3>
    <input type="number" id="cantidad" placeholder="Cantidad" min="0" required><br>
    <label><input type="checkbox" id="solicito"> Solicit√≥</label><br><br>
    <button class="capturar" onclick="capturarDato()">Capturar</button>
  </div>
</div>

<form id="formulario-caja" style="display:none;">
  <table>
    <thead>
      <tr>
        <th>Art√≠culo</th>
        <th>Cantidad</th>
        <th>Solicit√≥</th>
      </tr>
    </thead>
    <tbody id="tabla-articulos"></tbody>
  </table>
  <button type="submit" class="guardar">Guardar Inventario</button>
</form>

<div class="footer">
  Aplicaci√≥n para administraci√≥n de inventarios para PYMES ‚Äî Alejandro Ornelas Orom Soluciones
</div>

<script>
const articulos = [
  "CONO CHICO", "CONO GDE", "QUESOCREMA", "COCA VIDRIO", "COCACOLA", "COCACOLA 2L",
  "FANTA", "FRESCA", "MANZANITA", "SPRITE", "RANCH", "AGUA 1LT", "BOLSA CAM",
  "BOLSA DE KG", "SERVILLETAS", "TENEDOR", "CURTIDOS NACHOS GDE", "QUESO AMAR",
  "ESCOBA", "PAPEL BA√ëO", "RAID MOSC", "LIMON", "HAPPY BOX", "MINI BOX", "CHAROLA",
  "TAKIS", "ANGUILA", "SALSA HABANERO", "TARTARA", "PALILLOS", "COFIAS", "CLORO",
  "FABULOSO", "JABON", "ROLLO IMPRE"
];

const server = "https://inventario-horom-production.up.railway.app";
let datosCapturados = [];
let indexArticulo = 0;
const modal = document.getElementById("modal");
const nombreArticulo = document.getElementById("nombre-articulo");
const cantidadInput = document.getElementById("cantidad");
const solicitoCheck = document.getElementById("solicito");
const tabla = document.getElementById("tabla-articulos");

function mostrarModal() {
  if (indexArticulo >= articulos.length) {
    modal.style.display = "none";
    document.getElementById("formulario-caja").style.display = "block";
    cargarTabla();
    return;
  }
  nombreArticulo.textContent = articulos[indexArticulo];
  cantidadInput.value = "";
  solicitoCheck.checked = false;
  modal.style.display = "block";
}

function capturarDato() {
  const cantidad = cantidadInput.value.trim();
  if (cantidad === "") {
    alert("‚ùå Debes capturar una cantidad antes de continuar.");
    return;
  }
  datosCapturados.push({
    articulo: articulos[indexArticulo],
    cantidad: cantidad,
    solicito: solicitoCheck.checked ? "S√≠" : "No"
  });
  indexArticulo++;
  mostrarModal();
}

function cargarTabla() {
  tabla.innerHTML = "";
  datosCapturados.forEach(dato => {
    tabla.innerHTML += `
      <tr>
        <td>${dato.articulo}</td>
        <td>${dato.cantidad}</td>
        <td>${dato.solicito}</td>
      </tr>
    `;
  });
}

// Evitar cerrar accidentalmente
window.addEventListener('beforeunload', function (e) {
  e.preventDefault();
  e.returnValue = '';
});

document.getElementById("formulario-caja").addEventListener("submit", async (e) => {
  e.preventDefault();

  const mensaje = document.createElement("div");
  mensaje.classList.add("mensaje");
  document.body.appendChild(mensaje);

  const datosUsuario = JSON.parse(localStorage.getItem("tempDatos"));
  if (!datosUsuario) {
    mensaje.style.color = "red";
    mensaje.textContent = "‚ùå No se encontraron los datos del usuario.";
    return;
  }

  const datos = {};
  datosCapturados.forEach(dato => {
    datos[dato.articulo] = `${dato.cantidad} | Solicito: ${dato.solicito}`;
  });

  try {
    if (datosUsuario.modoEdicion) {
      await fetch(`${server}/editar-nombre/${datosUsuario.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ articulos: datos, usuario: datosUsuario.usuario })
      });
    } else {
      await fetch(`${server}/guardar-nombre`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...datosUsuario, articulos: datos })
      });
    }

    mensaje.style.color = "green";
    mensaje.textContent = "‚úÖ Inventario guardado exitosamente.";
    localStorage.removeItem("tempDatos");
    localStorage.setItem("actualizarInventario", "true");
    localStorage.setItem("actualizarCompras", "true");
    window.removeEventListener('beforeunload', () => {});
    setTimeout(() => window.close(), 1200);

  } catch (error) {
    console.error(error);
    mensaje.style.color = "red";
    mensaje.textContent = "‚ùå Error al guardar el inventario.";
  }
});

// Comienza inmediatamente
mostrarModal();
</script>

</body>
</html>
