<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Inventarios Registrados</title>
  <style>
    body {font-family: Arial, sans-serif; text-align: center; padding: 20px;}
    table {margin: auto; width: 90%; border-collapse: collapse;}
    th, td {border: 1px solid #ccc; padding: 10px;}
    th {background-color: #f2f2f2;}
    button {padding: 5px 10px; margin: 5px; border: none; border-radius: 5px; background: #3498db; color: white; cursor: pointer;}
    button:hover {background: #2980b9;}
    .btn-eliminar {background: #e74c3c;}
    .btn-eliminar:hover {background: #c0392b;}
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); text-align: center; padding-top: 80px; z-index: 1000;
    }
    .modal-content {
      background: white; margin: auto; padding: 20px; border-radius: 10px; width: 80%; max-height: 90vh; overflow-y: auto;
    }
  </style>
</head>
<body>

<h2>Inventarios Registrados üì¶</h2>

<table>
  <thead>
    <tr>
      <th>Nombre</th>
      <th>Ubicaci√≥n</th>
      <th>√Årea</th>
      <th>Fecha</th>
      <th>Inventario</th>
      <th>Historial</th>
      <th>Eliminar</th>
    </tr>
  </thead>
  <tbody id="tabla-inventarios"></tbody>
</table>

<!-- Modal Ver Inventario -->
<div id="modal-inventario" class="modal">
  <div class="modal-content">
    <h3>Art√≠culos Capturados</h3>
    <table style="width:100%; margin-top:10px;">
      <thead>
        <tr><th>Art√≠culo</th><th>Cantidad</th><th>Solicito</th></tr>
      </thead>
      <tbody id="inventario-body"></tbody>
    </table>
    <br>
    <button onclick="cerrarModalInventario()">Cerrar</button>
  </div>
</div>

<!-- Modal Ver Historial -->
<div id="modal-historial" class="modal">
  <div class="modal-content">
    <h3>Historial de Modificaciones</h3>
    <table style="width:100%; margin-top:10px;">
      <thead>
        <tr><th>Usuario</th><th>Acci√≥n</th><th>Fecha</th></tr>
      </thead>
      <tbody id="historial-body"></tbody>
    </table>
    <br>
    <button onclick="cerrarModalHistorial()">Cerrar</button>
  </div>
</div>

<script>
let inventarios = [];

async function cargarInventarios(){
  const res = await fetch("http://localhost:3000/nombres");
  inventarios = await res.json();
  const tabla = document.getElementById("tabla-inventarios");
  tabla.innerHTML = "";

  inventarios.forEach(inv => {
    const fecha = new Date(inv.creadoEn).toLocaleDateString();
    tabla.innerHTML += `
      <tr>
        <td>${inv.nombre}</td>
        <td>${inv.ubicacion}</td>
        <td>${inv.area}</td>
        <td>${fecha}</td>
        <td><button onclick="verInventario('${inv._id}')">Ver Inventario</button></td>
        <td><button onclick="verHistorial('${inv._id}')">Ver Historial</button></td>
        <td><button class="btn-eliminar" onclick="eliminarInventario('${inv._id}')">Eliminar</button></td>
      </tr>
    `;
  });
}

// Mostrar inventario SIN filtro de "Solicito"
function verInventario(id){
  const inventario = inventarios.find(i => i._id === id);
  const tbody = document.getElementById("inventario-body");
  tbody.innerHTML = "";

  if (!inventario.articulos || Object.keys(inventario.articulos).length === 0) {
    tbody.innerHTML = `<tr><td colspan="3">Sin art√≠culos capturados.</td></tr>`;
    return;
  }

  for (const [articulo, data] of Object.entries(inventario.articulos)) {
    const cantidad = data.cantidad ?? "-";
    const solicito = data.solicito === "si" ? "‚úÖ" : "";

    tbody.innerHTML += `
      <tr>
        <td>${articulo}</td>
        <td>${cantidad}</td>
        <td>${solicito}</td>
      </tr>`;
  }

  document.getElementById("modal-inventario").style.display = "block";
}

// Mostrar historial
function verHistorial(id){
  const inventario = inventarios.find(i => i._id === id);
  const tbody = document.getElementById("historial-body");
  tbody.innerHTML = "";

  if (!inventario.historial || inventario.historial.length === 0) {
    tbody.innerHTML = `<tr><td colspan="3">Sin modificaciones registradas.</td></tr>`;
  } else {
    inventario.historial.forEach(h => {
      const fecha = new Date(h.fecha).toLocaleString();
      tbody.innerHTML += `<tr><td>${h.usuario}</td><td>${h.accion}</td><td>${fecha}</td></tr>`;
    });
  }

  document.getElementById("modal-historial").style.display = "block";
}

// Eliminar inventario
async function eliminarInventario(id){
  const clave = prompt("‚ö†Ô∏è Introduce la supercontrase√±a para eliminar:");
  if (clave !== "Pelon93.") {
    alert("‚ùå Contrase√±a incorrecta. No autorizado.");
    return;
  }

  if (!confirm("¬øEst√°s seguro de eliminar este inventario? Esta acci√≥n no se puede deshacer.")) {
    return;
  }

  try {
    const res = await fetch(`http://localhost:3000/eliminar-nombre/${id}`, {
      method: "DELETE"
    });

    const mensaje = await res.text();
    alert(mensaje);
    cargarInventarios();
  } catch (error) {
    console.error("Error al eliminar:", error);
    alert("‚ùå Error al eliminar inventario.");
  }
}

function cerrarModalInventario(){
  document.getElementById("modal-inventario").style.display = "none";
}
function cerrarModalHistorial(){
  document.getElementById("modal-historial").style.display = "none";
}

cargarInventarios();
</script>

<!-- üîÑ Escuchar cambios autom√°ticos -->
<script>
window.addEventListener("storage", function(e) {
  if (e.key === "actualizarInventario" && e.newValue === "true") {
    cargarInventarios();
  }
});
</script>

</body>
</html>
